# GX1 Artifacts and Paths - File Structure Reference

**Last Updated:** 2025-12-15

---

## Configuration Files

### Policy Configs (YAML)

**Base Directory:** `gx1/configs/policies/`

**Active Configs:**
- `gx1/configs/policies/active/GX1_V11_OANDA_DEMO_V9_FARM_V2B_EXIT_HYBRID_V3_FULLYEAR.yaml`
  - Full-year 2025 replay config
  - Includes guardrail: `v3_range_edge_cutoff: 1.0`

**2024 Configs (for validation):**
- `gx1/configs/policies/active/GX1_V11_OANDA_DEMO_V9_FARM_V2B_EXIT_HYBRID_V3_2024_BASELINE.yaml`
  - Baseline (no guardrail)
- `gx1/configs/policies/active/GX1_V11_OANDA_DEMO_V9_FARM_V2B_EXIT_HYBRID_V3_2024_GUARDRAIL.yaml`
  - Guardrail version

**Production Snapshot:**
- `gx1/configs/policies/prod_snapshot/2025_FARM_V2B_HYBRID_V3_RANGE/GX1_V11_OANDA_DEMO_V9_FARM_V2B_EXIT_HYBRID_V3_RANGE_PROD.yaml`
  - PROD_BASELINE frozen 2025-12-15
  - Includes router model path: `exit_router_models_v3/exit_router_v3_tree.pkl`

**Entry Configs:**
- `gx1/configs/policies/prod_snapshot/2025_FARM_V2B_HYBRID/ENTRY_V9_FARM_V2B_PROD.yaml`
  - Entry policy config (FARM_V2B)

**Exit Configs:**
- `gx1/configs/exits/FARM_EXIT_V2_RULES_A_mp68_max5_rule5_cd0.yaml`
  - RULE5 exit policy
- `gx1/configs/exits/FARM_EXIT_V2_RULES_ADAPTIVE_v1.yaml`
  - RULE6A exit policy

---

## Model Artifacts

### Entry Models

**Session-Routed Models (Legacy):**
- **Location:** `gx1/models/`
- **Format:** XGBoost models (joblib/pickle)
- **Files:**
  - `gx1/models/GX1_entry_EU.joblib` (EU session model)
  - `gx1/models/GX1_entry_US.joblib` (US session model)
  - `gx1/models/GX1_entry_OVERLAP.joblib` (OVERLAP session model)
- **Metadata:** `gx1/models/GX1_entry_session_metadata.json`
  - Contains: `feature_cols`, `feature_cols_hash`, `model_bundle_version`
- **Loading:** `gx1/execution/oanda_demo_runner.py:load_entry_models()` (line 444)
- **Called from:** `GX1DemoRunner.__init__()` (line 2184)
- **Note:** These are legacy session-routed models. FARM_V2B uses ENTRY_V9 transformer directly (skips these).

**ENTRY_V9 Transformer Models (FARM_V2B):**
- **Location:** `gx1/models/entry_v9/nextgen_2020_2025_clean/`
- **Format:** Transformer models (PyTorch/joblib)
- **Status:** Loaded directly by FARM_V2B policy, not via `load_entry_models()`

---

### Router Models (V3_RANGE)

**Primary Location:** `gx1/analysis/exit_router_models_v3/`

**Files:**
- `exit_router_v3_tree.pkl`
  - Trained DecisionTreeClassifier model (sklearn)
  - Format: joblib pickle
  - Loaded at runtime: `gx1/core/hybrid_exit_router.py:217`

- `exit_router_v3_tree_rules.txt`
  - Human-readable tree rules (exported via `export_text()`)
  - Format: Plain text
  - Generated during training

- `exit_router_v3_metrics.json`
  - Training metrics (accuracy, confusion matrix, etc.)
  - Format: JSON
  - Generated during training

- `exit_router_comparison_fullyear.json`
  - FULLYEAR comparison metrics
  - Format: JSON
  - Generated during evaluation

**Production Snapshot:**
- `gx1/configs/policies/prod_snapshot/2025_FARM_V2B_HYBRID_V3_RANGE/exit_router_models_v3/`
  - Frozen PROD_BASELINE models (copied from analysis directory)

---

## Dataset Artifacts

### Training Dataset (V3)

**Location:** `gx1/analysis/`

**Files:**
- `exit_policy_training_dataset_v3.csv`
  - Training dataset (CSV format)
  - Columns: `trade_id`, `policy_best`, `atr_pct`, `spread_pct`, `range_pos`, `distance_to_range`, `range_edge_dist_atr`, etc.
  - Generated by: `build_exit_policy_training_dataset_v3.py`

- `exit_policy_training_dataset_v3.parquet`
  - Same dataset (Parquet format, faster loading)

- `exit_policy_training_dataset_v3_metadata.json`
  - Dataset metadata:
    - `n_rows`, `n_columns`, `columns`
    - `range_pos_stats`, `range_pos_missing_before_fill`
    - `range_edge_dist_atr_stats`, `range_edge_dist_atr_missing_before_fill`
    - `runs`: Mapping of tags to run directories
  - Generated by: `build_exit_policy_training_dataset_v3.py`

---

## Workflow Runs (wf_runs)

**Base Directory:** `gx1/wf_runs/`

**Structure:**
```
gx1/wf_runs/
  └─> <tag>/
        ├─> trade_log_chunk_0.csv
        ├─> trade_log_chunk_1.csv
        ├─> ...
        ├─> trade_log_*_merged.csv (merged trade log)
        ├─> results.json (summary metrics)
        ├─> price_data_filtered.parquet (filtered price data)
        ├─> parallel_chunks/ (chunk artifacts)
        │     ├─> chunk_0.parquet
        │     ├─> chunk_1.parquet
        │     ├─> policy_chunk_0.yaml
        │     └─> results_chunk_0.json
        └─> logs/
              └─> replay.log
```

**Example Tags:**
- `FARM_V2B_EXIT_HYBRID_ROUTER_V3_RANGE_FULLYEAR`
- `FARM_V2B_EXIT_HYBRID_ROUTER_V3_RANGE_2024_BASELINE`
- `FARM_V2B_EXIT_HYBRID_ROUTER_V3_RANGE_2024_GUARDRAIL`

**Trade Log CSV Columns:**
- `trade_id`, `entry_time`, `exit_time`
- `entry_price`, `exit_price`, `pnl_bps`
- `exit_profile` (RULE5 or RULE6A)
- `bars_held`
- `extra` (JSON string with range features, router context)

**Results JSON Structure:**
```json
{
  "n_trades": 162,
  "mean_pnl_bps": 117.67,
  "median_pnl_bps": 120.0,
  "trades_per_day": 0.44,
  "ev_per_day": 51.78,
  "tp2_rate": 0.xxx,
  "sl_rate": 0.xxx,
  "timeout_rate": 0.xxx,
  "sl_breakeven_rate": 0.xxx,
  "median_bars_held": 8.0
}
```

---

## Analysis Artifacts

### Comparison Scripts

**Location:** `gx1/analysis/`

**Scripts:**
- `compare_exit_routers_fullyear.py`
  - Compares baseline vs guardrail runs
  - Generates: Regime analysis, time-window analysis, intratrade risk analysis
  - Output: Terminal summary + CSV files

- `verify_guardrail_effect.py`
  - Detailed guardrail verification
  - Generates: `overridden_trades.csv`
  - Output: High-precision metrics, trade-diff analysis

**Output Files:**
- `overridden_trades.csv` (from `verify_guardrail_effect.py`)
  - Columns: `trade_key`, `baseline_exit_profile`, `guardrail_exit_profile`, `delta_pnl_bps`, `range_edge_dist_atr`, etc.

- `intratrade_risk_analysis.csv` (from `compare_exit_routers_fullyear.py`)
  - Columns: `trade_key`, `baseline_MFE_bps`, `guardrail_MFE_bps`, `baseline_MAE_bps`, `guardrail_MAE_bps`, etc.

---

## Log Files

**Location:** `gx1/wf_runs/<tag>/logs/`

**Files:**
- `replay.log`
  - Full replay execution log
  - Format: Standard Python logging
  - Includes: Entry/exit decisions, router predictions, guardrail overrides

**Log Levels:**
- `INFO`: Major events (trade creation, exit execution)
- `DEBUG`: Detailed feature values, router decisions
- `WARNING`: Guardrail overrides, fallback logic

**Key Log Tags:**
- `[RANGE_FEAT]`: Range feature computation
- `[HYBRID_EXIT]`: Router selection and guardrail
- `[EXIT]`: Exit evaluation
- `[ENTRY]`: Entry evaluation

---

## Production Safety Files

**Kill Switch:**
- `{project_root}/KILL_SWITCH_ON`
  - Created by: ops_watch.py cron job (UKJENT – må verifiseres)
  - Effect: Blocks all trading when file exists
  - Checked: `gx1/execution/oanda_demo_runner.py:6078`

**Policy Lock:**
- Policy hash computed at startup: `self.policy_hash` (MD5 of policy file)
- Checked: `gx1/execution/oanda_demo_runner.py:6084`
- Effect: Blocks trading if policy file modified

---

## Price Data

**Environment Variable:** `M5_DATA`

**Expected Format:**
- Parquet or CSV
- Columns: `time` (index), `open`, `high`, `low`, `close`, `volume`
- Bid/Ask columns: `bid_open`, `bid_high`, `bid_low`, `bid_close`, `ask_open`, `ask_high`, `ask_low`, `ask_close`

**Filtered Data:**
- `gx1/wf_runs/<tag>/price_data_filtered.parquet`
  - Filtered to date range by `scripts/run_replay.sh`
  - Used by parallel replay chunks

---

## Documentation

**Pipeline Docs:**
- `docs/pipeline/PIPELINE_OVERVIEW.md` (this directory)
- `docs/pipeline/CALLGRAPH.md`
- `docs/pipeline/ARTIFACTS_AND_PATHS.md` (this file)
- `docs/pipeline/CONFIG_SURFACE.md`
- `docs/pipeline/INVARIANTS_AND_CHECKS.md`
- `docs/pipeline/DIAGRAM.mmd`

**Production Docs:**
- `gx1/configs/policies/prod_snapshot/2025_FARM_V2B_HYBRID_V3_RANGE/FARM_V2B_HYBRID_V3_RANGE_PROD_BASELINE.md`
  - PROD_BASELINE documentation
  - Includes: Performance metrics, guardrail verification, frozen date

**Main README:**
- `README.md`
  - Includes guardrail documentation sentence

---

## Key Paths Summary

| Artifact Type | Path Pattern | Example |
|---------------|-------------|---------|
| Policy Configs | `gx1/configs/policies/active/*.yaml` | `GX1_V11_OANDA_DEMO_V9_FARM_V2B_EXIT_HYBRID_V3_FULLYEAR.yaml` |
| Router Models | `gx1/analysis/exit_router_models_v3/*.pkl` | `exit_router_v3_tree.pkl` |
| Training Dataset | `gx1/analysis/exit_policy_training_dataset_v3.*` | `.csv`, `.parquet`, `_metadata.json` |
| Workflow Runs | `gx1/wf_runs/<tag>/` | `FARM_V2B_EXIT_HYBRID_ROUTER_V3_RANGE_FULLYEAR/` |
| Trade Logs | `gx1/wf_runs/<tag>/trade_log_*.csv` | `trade_log_chunk_0.csv` |
| Analysis Output | `gx1/analysis/` (or current dir) | `overridden_trades.csv` |
| Logs | `gx1/wf_runs/<tag>/logs/replay.log` | `replay.log` |
| Kill Switch | `{project_root}/KILL_SWITCH_ON` | `KILL_SWITCH_ON` |

---

## Notes

- **Model Versioning:** Router models are frozen in PROD_BASELINE snapshot
- **Dataset Versioning:** Training dataset includes metadata with run tags
- **Trade Log Schema:** See `gx1/execution/trade_log_schema.py` (if exists)
- **Parallel Chunks:** Each chunk writes separate trade log, merged at end
- **Price Data:** Filtered to date range before parallel execution

