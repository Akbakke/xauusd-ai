# GX1 v1.1 → Hybrid exit controller V3_RANGE (PROD_BASELINE)
#
# Entry: FARM_V2B mp68_max5_cd0 (long-only)
# Exit: HYBRID_ROUTER_V3 - ML decision tree with range features (range_pos, distance_to_range, range_edge_dist_atr)
# Status: PROD_BASELINE (frozen 2025-12-14)
#
# V3_RANGE routing logic:
#   - Based on V3 decision tree trained on FULLYEAR 2025 data (1592 trades)
#   - Features: atr_pct, spread_pct, range_pos, distance_to_range, range_edge_dist_atr
#   - Tree uses range_edge_dist_atr in splits (range-aware routing)
#   - RULE5 default, RULE6A allocated based on ML predictions
#   - GUARDRAIL: RULE6A only allowed when range_edge_dist_atr < 1.0
#     (RULE6A er en edge-spesialisert exit, kun aktivert nær range edges)
#
# Tree structure (from exit_router_v3_tree_rules.txt):
#   - Primary splits on atr_pct
#   - Secondary splits on spread_pct
#   - Uses range_edge_dist_atr for edge cases (high spread > 98.47)
#   - RULE6A allocated in moderate ATR ranges (6.81-33.50) with acceptable spread
#
# Performance (FULLYEAR 2025):
#   - 162 trades
#   - EV/trade: 117.67 bps
#   - Win rate: 84.6%
#   - RULE5: 105 trades (64.8%), Mean PnL: 120.56 bps
#   - RULE6A: 57 trades (35.2%), Mean PnL: 112.33 bps
#   - RULE6A near edge (range_edge_dist_atr < 2.0): 50.9%

meta:
  router_version: V3_RANGE
  role: PROD_BASELINE
  frozen_date: 2025-12-15
  description: >
    HYBRID_ROUTER_V3_RANGE (decision-tree with range features + guardrail). PROD_BASELINE frozen 2025-12-15.
    Uses range_pos, distance_to_range, and range_edge_dist_atr for range-aware routing.
    Guardrail: RULE6A only allowed when range_edge_dist_atr < 1.0 (edge-specialized exit).
    Trained on FULLYEAR 2025 data (1592 trades). With guardrail: 117.67 bps EV/trade, 84.6% win rate, 9.3% RULE6A allocation.

policy_name: GX1_V11_OANDA_DEMO_V9_FARM_V2B_EXIT_HYBRID_V3_RANGE_PROD
version: "GX1_V11_OANDA_DEMO_V9_FARM_V2B_EXIT_HYBRID_V3_RANGE_PROD"
mode: "REPLAY"
instrument: "XAU_USD"
timeframe: "M5"
warmup_bars: 288

entry_config: gx1/configs/policies/prod_snapshot/2025_FARM_V2B_HYBRID/ENTRY_V9_FARM_V2B_PROD.yaml
exit_config: gx1/configs/exits/FARM_EXIT_V2_RULES_A_mp68_max5_rule5_cd0.yaml

exit_policies:
  rule5: gx1/configs/exits/FARM_EXIT_V2_RULES_A_mp68_max5_rule5_cd0.yaml
  rule6a: gx1/configs/exits/FARM_EXIT_V2_RULES_ADAPTIVE_v1.yaml

exit_hybrid:
  enabled: true
  mode: RULE5_RULE6A_ATR_SPREAD_V1
  atr_low_pct: 0.0
  atr_high_pct: 75.0
  max_spread_pct: 40.0
  allowed_regimes:
    - FARM_ASIA_MEDIUM
  exit_params:
    enable_tp: true
    enable_trailing: true
    enable_be: true

hybrid_exit_router:
  version: HYBRID_ROUTER_V3
  v3_range_edge_cutoff: 1.0  # Guardrail: RULE6A only allowed when range_edge_dist_atr < 1.0
  model_path: gx1/configs/policies/prod_snapshot/2025_FARM_V2B_HYBRID_V3_RANGE/exit_router_models_v3/exit_router_v3_tree.pkl
  documentation: |
    HYBRID_ROUTER_V3_RANGE provides ML-based routing using decision tree trained on range features:
    
    GUARDRAIL:
      RULE6A er en edge-spesialisert exit, kun aktivert når range_edge_dist_atr < 1.0.
      I øvrige regimer gir den ingen målbar forbedring i PnL eller risiko og er derfor deaktivert.
    
    Key features:
      - atr_pct: ATR in basis points
      - spread_pct: Spread in basis points
      - range_pos: Position in range [0.0, 1.0]
      - distance_to_range: Distance to range [0.0, 1.0]
      - range_edge_dist_atr: ATR-normalized distance to nearest range edge [0.0, 10.0]
    
    Tree structure:
      - Primary splits on atr_pct (thresholds: 6.81, 10.65, 33.50, 61.34)
      - Secondary splits on spread_pct (thresholds: 0.50, 98.47)
      - Uses range_edge_dist_atr for high-spread edge cases (threshold: 0.08)
      - RULE6A allocated in moderate ATR ranges with acceptable spread
    
    Performance (with guardrail):
      - Trained on 1592 trades (FULLYEAR 2025)
      - Accuracy: 73.2%
      - FULLYEAR replay: 162 trades, 117.67 bps EV/trade, 84.6% win rate
      - RULE6A allocation: 9.3% of trades (15 trades, all with range_edge_dist_atr < 1.0)
      - Guardrail blocked 42 trades from RULE6A (range_edge_dist_atr >= 1.0)
      - All blocked trades had identical PnL under RULE5 vs RULE6A (RULE6A was "cosmetic")

logging:
  level: INFO
  log_dir: gx1/wf_runs/GX1_V11_OANDA_DEMO_V9_FARM_V2B_EXIT_HYBRID_V3_RANGE_PROD/logs

execution:
  max_open_trades: 5

risk:
  min_time_between_trades_sec: 0

