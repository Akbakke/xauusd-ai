# GX1 v1.1 → SNIPER entry policy (EU/London/NY) - P4 CANARY
#
# Entry: SNIPER P4 (p_long>=0.80 + regime blocks NEUTRAL/HIGH & DOWN/HIGH)
# Exit: HYBRID_ROUTER_V3 - ML decision tree with range features
# Status: CANARY (not PROD_BASELINE)
#
# SNIPER P4 CANARY:
#   - p_long >= 0.80 (higher selectivity)
#   - Regime blocks: TREND_NEUTRAL×HIGH and TREND_DOWN×HIGH
#   - Stricter concurrency: max_open_trades=3, min_time_between_trades_sec=180
#   - Same exit engine (Hybrid router V3 + RULE5/RULE6A)
#
# IMPORTANT: This is SNIPER P4 CANARY bundle - isolated from FARM PROD_BASELINE

meta:
  router_version: V3_RANGE
  name: "SNIPER_P4_CANARY"
  role: CANARY  # NOT PROD_BASELINE
  description: >
    SNIPER P4 combined: p_long>=0.80 + regime blocks (NEUTRAL/HIGH & DOWN/HIGH) + max_open_trades=3 + cooldown=180s
    Higher selectivity than baseline SNIPER.
    Uses same exit engine (Hybrid router V3 + RULE5/RULE6A).
  bundle_location: sniper_snapshot/2025_SNIPER_V1

policy_name: GX1_V11_OANDA_DEMO_SNIPER_P4_CANARY
version: "GX1_V11_OANDA_DEMO_SNIPER_P4_CANARY"
mode: "LIVE"  # or "REPLAY"
run_mode: "PROD"  # PROD | SHADOW (SHADOW: journal trades, no real orders)
instrument: "XAU_USD"
timeframe: "M5"
warmup_bars: 288

# SNIPER-specific entry config (P4: p_long 0.80 + regime blocks)
entry_config: gx1/configs/policies/sniper_snapshot/2025_SNIPER_V1/ENTRY_V9_SNIPER_LONDON_NY_P4.yaml

# SNIPER-specific exit configs (in sniper_snapshot/exits)
exit_config: gx1/configs/policies/sniper_snapshot/2025_SNIPER_V1/exits/SNIPER_EXIT_RULES_A.yaml

exit_policies:
  rule5: gx1/configs/policies/sniper_snapshot/2025_SNIPER_V1/exits/SNIPER_EXIT_RULES_A.yaml
  rule6a: gx1/configs/policies/sniper_snapshot/2025_SNIPER_V1/exits/SNIPER_EXIT_RULES_ADAPTIVE.yaml

hybrid_exit_router:
  version: HYBRID_ROUTER_V3
  # In v1: Use same router model as FARM (can be tuned via params later)
  model_path: gx1/models/exit_router/exit_router_v3_tree.pkl
  # SNIPER-specific router parameters (can be tuned independently)
  v3_range_edge_cutoff: 1.0  # Start with same as FARM (can tune later)
  # Future: session-specific cutoffs, vol-specific thresholds
  documentation: |
    HYBRID_ROUTER_V3_RANGE provides ML-based routing using decision tree trained on range features.
    In v1: Uses same router model as FARM PROD_BASELINE.
    SNIPER can tune router parameters (cutoffs, thresholds) via config without affecting FARM.

execution:
  dry_run: false
  max_open_trades: 3  # P4: Stricter concurrency limit
  min_time_between_trades_sec: 180  # P4: 3 min cooldown between entries

# SNIPER Risk Guard V1 configuration
risk_guard:
  config_path: gx1/configs/policies/sniper_snapshot/2025_SNIPER_V1/SNIPER_RISK_GUARD_V1.yaml

logging:
  level: INFO

backfill:
  enabled: true
  overlap_bars: 6
  lookback_padding: 100
  target_bars_padding: 100

# Exit control (ExitArbiter configuration)
# SNIPER-specific: Allow SL_TICK for tick-based stop-loss in live mode
# Note: In replay mode, SL_TICK should not occur (TickWatcher disabled)
exit_control:
  allowed_loss_closers:
    - RULE_A_PROFIT
    - RULE_A_TRAILING
    - RULE_B_FAST_LOSS
    - RULE_C_TIMEOUT
    - BROKER_SL  # Allows SL_TICK automatically (see oanda_demo_runner.py line 4994-4995)
    - SL_TICK    # Explicitly allow SL_TICK for SNIPER (tick-based stop-loss)
    - REPLAY_EOF # Always allowed in replay mode for end-of-simulation liquidation
  require_trade_open: true

# Replay-specific configuration
replay:
  close_open_trades_at_end: true  # Close all open trades at end of replay for complete analysis
  eof_close_reason: "REPLAY_EOF"  # Reason code for EOF-closed trades
  eof_price_source: "mid"  # Price source for EOF close: "mid", "bid", or "ask"

sniper_q4_cchop_overlay:
  enabled: true
  multipliers:
    EU: 1.00
    OVERLAP: 1.00
    US: 0.50
  default_multiplier: 1.00

# ExitCritic V1 configuration
exit_critic:
  enabled: true
  model_path: models/exit_critic/exit_critic_xgb_v1.json
  metadata_path: models/exit_critic/exit_critic_xgb_v1.meta.json
  
  # Thresholds
  exit_now_threshold: 0.60
  scalp_threshold: 0.40
  
  # Guards
  guards:
    min_bars_held: 5        # Don't use critic if trade is too fresh
    apply_for_loss_leq: -40.0  # Use EXIT_NOW only if pnl <= -40 bps
    apply_for_profit_ge: 40.0   # Use SCALP_PROFIT only if pnl >= 40 bps
    allowed_sessions:
      - EU
      - OVERLAP
      - US
    allowed_vol_regimes:
      - LOW
      - MEDIUM
      - HIGH
    allowed_trend_regimes:
      - TREND_UP
      - TREND_NEUTRAL
      - TREND_DOWN

